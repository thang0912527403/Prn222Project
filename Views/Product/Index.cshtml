@using Prn222Project.Models
@model List<Product>

@{
    ViewData["Title"] = "Sản phẩm";
}

<!-- Helpers palette (bỏ nếu đã có trong layout) -->
<style>
  :root{
    --bg:#F6F3EA; --card:#EFE7D6; --line:#CBBE9F; --text:#2B2F36;
    --primary:#3C7A6E; --secondary:#C46A3B; --accent:#D8A542;
  }
  html.dark{
    --bg:#0F172A; --card:#1E2537; --line:#2E374F; --text:#EDEAE2;
    --primary:#8FBF93; --secondary:#D07B54; --accent:#E6C45E;
  }
  .theme-card{ background:var(--card); }
  .theme-line{ border-color:var(--line)!important; }
  .theme-text{ color:var(--text); }
  .text-primary{ color:var(--primary)!important; }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-primary:hover{ filter:brightness(1.05); }
  .shadow-card{ box-shadow:0 8px 24px rgba(0,0,0,.12) }
</style>

<form method="get" asp-action="Index" asp-controller="Product" class="space-y-6">

    <!-- FILTER BAR -->
    <div class="theme-card border theme-line">
        <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2">

            <!-- Search (chỉ submit khi Enter hoặc nút Áp dụng) -->
            <input id="q" name="search" value="@(ViewBag.Search as string)"
                   placeholder="Tìm sản phẩm..."
                   class="h-10 flex-1 min-w-[220px] p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm" />

            <!-- Category -->
            <select name="categories"
                    class="h-10 w-40 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm">
                <option value="">Danh mục</option>
                @if (ViewBag.Categories != null)
                {
                    foreach (var c in ViewBag.Categories)
                    {
                        <option value="@c.Id" selected="@(ViewBag.cate == c.Id)">@c.Name</option>
                    }
                }
            </select>

            <!-- Sort -->
            <select name="orderBy"
                    class="h-10 w-28 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm">
                <option value="">Sắp xếp</option>
                <option value="price" selected="@(ViewBag.Orderby == "price")">Giá</option>
                <option value="name" selected="@(ViewBag.Orderby == "name")">Tên</option>
            </select>

            <select name="orderStatus"
                    class="h-10 w-28 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm">
                <option value="Ascending" selected="@(ViewBag.OrderStatus == "Ascending")">Tăng dần</option>
                <option value="Descending" selected="@(ViewBag.OrderStatus == "Descending")">Giảm dần</option>
            </select>

            <!-- More (giá + page size) -->
            <details class="shrink-0">
                <summary class="h-10 px-3 inline-flex items-center rounded-lg bg-dark-3 text-gray-200 border border-gray-700 text-sm cursor-pointer">
                    Thêm tuỳ chọn
                </summary>
                <div class="mt-2 flex flex-wrap items-center gap-2">
                    <input name="minPrice" type="number" min="0" value="@(ViewBag.MinPrice)"
                           placeholder="Giá từ"
                           class="h-10 w-28 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm" />
                    <input name="maxPrice" type="number" min="0" value="@(ViewBag.MaxPrice)"
                           placeholder="Giá đến"
                           class="h-10 w-28 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm" />
                    <select name="pageSize"
                            class="h-10 w-24 p-2 rounded-lg bg-dark-3 text-white border border-gray-700 focus:ring-green-500 text-sm">
                        <option value="">Hiển thị</option>
                        @foreach (var size in new[] { 4, 8, 12, 16, 20 })
                        {
                            <option value="@size" selected="@(ViewBag.PageSize == size)">@size</option>
                        }
                    </select>
                </div>
            </details>

            <!-- Actions -->
            <a asp-action="Index" asp-controller="Product"
               class="h-10 px-3 inline-flex items-center rounded-lg bg-gray-700 text-gray-100 hover:bg-gray-600 text-sm border border-gray-600">
                Xóa lọc
            </a>
            <button type="submit"
                    class="h-10 px-3 inline-flex items-center rounded-lg btn-primary text-sm font-medium">
                Áp dụng
            </button>
        </div>
    </div>

    <!-- GRID -->
    <div class="max-w-6xl mx-auto px-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-6">
            @if (Model != null && Model.Count > 0)
            {
                foreach (var p in Model)
                {
                    <div onclick="window.location.href='/Product/Details/@p.Id'"
                         class="cursor-pointer theme-card hover:bg-white/60 dark:hover:bg-white/5 transition rounded-xl p-4 text-center border theme-line shadow-card hover:scale-[1.02]">
                        <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? Url.Content("~/images/no-image.jpg") : p.ImageUrl)"
                             alt="@p.Name"
                             class="w-full h-32 object-cover rounded-md mb-4 border border-gray-600/50" />
                        <div class="theme-text font-semibold text-base truncate">@p.Name</div>
                        <div class="text-primary font-bold mt-1">@p.Price.ToString("N0") đ</div>
                    </div>
                }
            }
            else
            {
                <div class="col-span-full text-center text-gray-400 py-10">
                    Không tìm thấy sản phẩm phù hợp.
                </div>
            }
        </div>
    </div>

    <!-- PAGINATION -->
    <div class="max-w-6xl mx-auto px-4">
        <div class="mt-8 flex justify-center items-center gap-4">
            <input onchange="this.form.submit()" type="text" value="@(ViewBag.Page ?? 1)" name="Page"
                   class="w-16 text-center p-2 rounded-lg bg-dark-3 text-white border border-gray-600 focus:ring-green-500" />
            <span class="theme-text opacity-80">/ @(ViewBag.TotalPage ?? 1) trang</span>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        // Không auto-submit khi đang gõ search:
        const q = document.getElementById('q');
        const form = q ? q.form : document.forms[0];
        if (q) {
          q.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              form.requestSubmit(); // submit khi Enter
            }
          });
        }

        // Tự submit khi đổi các select/number
        document.querySelectorAll('select[name], input[type="number"][name]').forEach(el=>{
          el.addEventListener('change', ()=> el.form?.requestSubmit());
        });
    </script>
}
